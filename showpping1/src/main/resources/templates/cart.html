<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¥ë°”êµ¬ë‹ˆ | ìœ í•œ ì˜· ë§ˆì¼“</title>
    <link rel="stylesheet" th:href="@{/style/style.css}"> 
    </head>
<body>

	<header class="header">
		    <div class="nav-bar">
		        <div class="logo">
		           <h1 style="margin: 0;">ìœ í•œ ì˜· ë§ˆì¼“</h1>
		        </div>
		        
		        <div class="search-and-user">
		            <a th:href="@{/}" class="menu-link">í™ˆ</a>
		            <a th:href="@{/shirtlist}" class="menu-link">ìƒì˜ ëª©ë¡</a>
					<a th:href="@{/cart}" class="menu-link">ì¥ë°”êµ¬ë‹ˆ</a>
		           
		            
		            <div class="user-status-group">
		                <span th:if="${session.user != null}" class="user-welcome">
		                    <span th:text="${session.user.username}"></span>ë‹˜, ì–´ì„œì˜¤ì„¸ìš”
		                </span>
		                
		                <a th:unless="${session.user != null}" th:href="@{/register}" class="btn btn-outline-primary btn-sm">
		                    <i class="bi bi-person-plus"></i> íšŒì›ê°€ì…
		                </a>
		                <a th:unless="${session.user != null}" th:href="@{/login}" class="btn btn-primary btn-sm">
		                    <i class="bi bi-box-arrow-in-right"></i> ë¡œê·¸ì¸
		                </a>
		                
		                <a th:if="${session.user != null}" th:href="@{/logout}" class="menu-link menu-link-button">
		                    <i class="bi bi-box-arrow-right"></i> ë¡œê·¸ì•„ì›ƒ
		                </a>
		            </div>
		        </div>
		    </div>
	</header>

    <main class="cart-container">
        <h1 class="page-title">ë‚´ ì¥ë°”êµ¬ë‹ˆ</h1>
        
        <form id="cartForm">
            <div th:if="${cartItems != null and not #lists.isEmpty(cartItems)}">
                
                <table class="cart-table">
                    <thead>
                        <tr>
                            <th>ìƒí’ˆ ì •ë³´</th>
                            <th>ì˜µì…˜</th>
                            <th>ë‹¨ê°€</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>í•©ê³„</th>
                            <th>ì„ íƒ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item, stat : ${cartItems}">
                            
                            <td class="product-cell">
                                <input type="hidden" name="cartItemId" th:value="${item.id}">
                                <div class="product-info-group">
                                    <a th:href="@{/product/{productId}(productId=${item.productOption.product.id})}">
                                        <img th:src="${item.productOption.product.imageUrl}" alt="ìƒí’ˆ ì´ë¯¸ì§€" class="cart-thumb">
                                        <span th:text="${item.productOption.product.name}">[ìƒí’ˆëª…] í”„ë¦¬ë¯¸ì—„ ìš¸ ë‹ˆíŠ¸</span>
                                    </a>
                                </div>
                            </td>
                            
                            <td th:text="${item.productOption.sizeName}">M</td>
                            
							<td th:with="price=${item.productOption.product.price}" class="price-cell">
							    <span th:text="${#numbers.formatDecimal(price, 0, 'COMMA', 0, 'POINT')}"
							          th:data-price="${price}"  th:id="'price-' + ${item.id}">79,000</span>ì›
							</td>
                            
                            <td class="quantity-cell">
                                <div class="quantity-control">
									<input type="number" 
									       th:id="'quantity-' + ${item.id}"
									       th:value="${item.quantity}" 
									       min="1" 
									       th:max="${item.productOption.stockQuantity}"
									       class="quantity-input"
									       
									       th:data-cart-item-id="${item.id}" 
									       
									       onchange="updateItemQuantity(this)">
                                </div>
                            </td>
                            
                            <td class="total-price-cell">
                                <span th:with="total=${item.quantity * item.productOption.product.price}"
                                      th:id="'total-' + ${item.id}"
                                      th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')}">158,000</span>ì›
                            </td>
                            
                            <td class="action-cell">
                                <button type="button" 
                                        class="btn-delete" 
                                        th:onclick="|deleteCartItem(${item.id})|">
                                    <i class="bi bi-x-circle"></i> ì‚­ì œ
                                </button>
                            </td>
                        </tr>
                        </tbody>
                </table>
				<div class="cart-summary">
				    <h2>ê²°ì œ ì˜ˆìƒ ê¸ˆì•¡</h2>
				    
				    <div class="summary-row">
				        <span>ì´ ìƒí’ˆ ê¸ˆì•¡</span>
				        <span id="subtotal" 
				              th:text="${#numbers.formatDecimal(T(com.showpping1.spring.util.CartUtils).calculateSubtotal(cartItems), 0, 'COMMA', 0, 'POINT')}">240,300</span>ì›
				    </div>
				    
				    <div class="summary-row">
				        <span>ë°°ì†¡ë¹„</span>
				        <span id="shippingFeeSpan" 
				              th:text="${T(com.showpping1.spring.util.CartUtils).getShippingFee(cartItems)} == 0 ? 'ë¬´ë£Œ' : ${#numbers.formatDecimal(T(com.showpping1.spring.util.CartUtils).getShippingFee(cartItems), 0, 'COMMA', 0, 'POINT')} + 'ì›'">ë¬´ë£Œ</span>
				    </div>
				    <hr>
				    
				    <div class="summary-row final-total-row"> 
				        <span>ì´ ì£¼ë¬¸ ê¸ˆì•¡</span> 
				        <span id="finalTotal" 
				              th:text="${#numbers.formatDecimal(T(com.showpping1.spring.util.CartUtils).calculateFinalTotal(cartItems), 0, 'COMMA', 0, 'POINT') + 'ì›'}">240,300ì›</span>
				    </div>
				    
				</div> 
				<div class="checkout-buttons-container">
				    <a th:href="@{/order/checkout}" class="btn-checkout" onclick="proceedToOrder()">
				        ì£¼ë¬¸í•˜ê¸°
				    </a>
				    <a th:href="@{/}" class="btn-continue">ì‡¼í•‘ ê³„ì†í•˜ê¸°</a>
				</div>


						  </div>
					  </div>
				    
				    </div>
            
            <div th:unless="${cartItems != null and not #lists.isEmpty(cartItems)}" class="empty-cart">
                <p>ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜­</p>
                <a th:href="@{/}" class="btn-continue">ìƒí’ˆ êµ¬ê²½í•˜ëŸ¬ ê°€ê¸°</a>
            </div>
            
        </form>
        
    </main>

    <footer class="footer">...</footer>

	<script>
	    // â­ï¸ cart.htmlì˜ ê¸°ì¡´ <script> ë‚´ìš©ì„ ì•„ë˜ë¡œ ë®ì–´ì“°ì„¸ìš”. â­ï¸

	    document.addEventListener('DOMContentLoaded', function() {
	        const cartSummary = document.querySelector('.cart-summary');
	        const finalTotalSpan = document.getElementById('finalTotal');
	        const subtotalSpan = document.getElementById('subtotal');

	        // í—¬í¼ í•¨ìˆ˜: ê¸ˆì•¡ í¬ë§·
	        function formatPrice(amount) {
	            return amount.toLocaleString('ko-KR');
	        }

	        // ----------------------------------------------------
	        // ğŸ’° 1. í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì¥ë°”êµ¬ë‹ˆ ìš”ì•½ ê¸ˆì•¡ì„ ê³„ì‚°í•˜ê³  ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
	        // ----------------------------------------------------
	        function updateSummaryTotals() {
	            let runningSubtotal = 0;
	            
	            // ëª¨ë“  ì¥ë°”êµ¬ë‹ˆ í•­ëª©ì˜ ê°œë³„ í•©ê³„ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ì´í•©ì„ êµ¬í•©ë‹ˆë‹¤.
	            document.querySelectorAll('tr').forEach(row => {
	                const itemId = row.querySelector('.quantity-input')?.getAttribute('data-cart-item-id');
	                if (!itemId) return; // í—¤ë” ë˜ëŠ” ë¹ˆ í–‰ ê±´ë„ˆë›°ê¸°

	                const quantityInput = row.querySelector(`#quantity-${itemId}`);
	                const priceSpan = row.querySelector(`#price-${itemId}`); // ë‹¨ê°€ (th:id="price-...")
	                const totalSpan = row.querySelector(`#total-${itemId}`); // í•©ê³„ (th:id="total-...")

	                if (quantityInput && priceSpan && totalSpan) {
	                    const price = parseFloat(priceSpan.getAttribute('th:data-price') || priceSpan.textContent.replace(/[^0-9]/g, '')) || 0;
	                    const quantity = parseInt(quantityInput.value) || 0;
	                    const itemTotal = price * quantity;
	                    
	                    totalSpan.textContent = formatPrice(itemTotal); // ê°œë³„ í•©ê³„ ì—…ë°ì´íŠ¸
	                    runningSubtotal += itemTotal;
	                }
	            });

	            // 2. ë°°ì†¡ë¹„ ê³„ì‚°
	            // (ì´ ë¡œì§ì€ ì„œë²„ì˜ CartUtilsì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆ: 5ë§Œì› ì´ìƒ ë¬´ë£Œ)
	            const shippingFee = runningSubtotal >= 50000 ? 0 : 3000;
	            const finalTotal = runningSubtotal + shippingFee;

	            // 3. ìš”ì•½ ì˜ì—­ ì—…ë°ì´íŠ¸
				const subtotalSpan = document.getElementById('subtotal');
				    if (subtotalSpan) {
				        subtotalSpan.textContent = formatPrice(runningSubtotal);
				    }
				    
				    // â­ï¸â­ï¸â­ï¸ ë°°ì†¡ë¹„ ì˜ì—­ ì—…ë°ì´íŠ¸ â­ï¸â­ï¸â­ï¸
				    const shippingFeeSpan = document.getElementById('shippingFeeSpan');
				    if (shippingFeeSpan) {
				        shippingFeeSpan.textContent = shippingFee === 0 ? 'ë¬´ë£Œ' : formatPrice(shippingFee) + 'ì›';
				    }
				    
				    // â­ï¸â­ï¸â­ï¸ ì´ ì£¼ë¬¸ ê¸ˆì•¡ (Final Total) ì—…ë°ì´íŠ¸ â­ï¸â­ï¸â­ï¸
				    const finalTotalSpan = document.getElementById('finalTotal');
				    if (finalTotalSpan) {
				        finalTotalSpan.textContent = formatPrice(finalTotal);
				    }
	        }
	        
	        // ----------------------------------------------------
	        // ğŸŒ 2. ì„œë²„ í†µì‹  (ìˆ˜ëŸ‰ ë³€ê²½ ì‹œ AJAX ìš”ì²­)
	        // ----------------------------------------------------
	        window.updateItemQuantity = function(inputElement) {
	            const itemId = inputElement.getAttribute('data-cart-item-id');
	            const newQuantity = parseInt(inputElement.value);
	            const maxQuantity = parseInt(inputElement.max);

	            if (newQuantity < 1) {
	                alert("ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
	                inputElement.value = 1;
	                return;
	            }
	            if (newQuantity > maxQuantity) {
	                alert(`ì¬ê³ ëŠ” ìµœëŒ€ ${maxQuantity}ê°œì…ë‹ˆë‹¤.`);
	                inputElement.value = maxQuantity;
	                return;
	            }

	            fetch('/cart/update', {
	                method: 'POST',
	                headers: { 
	                    'Content-Type': 'application/json',
	                },
	                credentials: 'include', // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
	                body: JSON.stringify({ cartItemId: itemId, quantity: newQuantity })
	            })
	            .then(response => {
	                if (!response.ok) {
	                    // ì„œë²„ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ íŒŒì‹±í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì£¼ê¸°
	                    return response.json().then(err => { throw new Error(err.message || 'ìˆ˜ëŸ‰ ë³€ê²½ ì‹¤íŒ¨'); });
	                }
	                return response.json(); 
	            })
	            .then(data => {
	                // DB ì—…ë°ì´íŠ¸ ì„±ê³µ í›„, í™”ë©´ì˜ ì´ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
	                updateSummaryTotals(); 
	                // alert('ìˆ˜ëŸ‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.'); // ë¬´ë¶„ë³„í•œ ì•Œë¦¼ ë°©ì§€
	            })
	            .catch(error => {
	                console.error('ìˆ˜ëŸ‰ ë³€ê²½ ì—ëŸ¬:', error);
	                alert('âŒ ìˆ˜ëŸ‰ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì¬ê³  í™•ì¸ í•„ìš”)');
	                // ì‹¤íŒ¨ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì›ìƒë³µêµ¬
	                window.location.reload(); 
	            });
	        };
			window.deleteCartItem = function(itemId, deleteButton) {
			    if (!confirm('ì •ë§ë¡œ ì´ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
			        return;
			    }

			    fetch('/cart/delete/' + itemId, {
			        method: 'POST',
			        credentials: 'include'
			    })
			    .then(response => {
			        if (!response.ok) {
			            // ì„œë²„ ì˜¤ë¥˜ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ íŒŒì‹±í•˜ì—¬ ë˜ì§‘ë‹ˆë‹¤.
			            return response.json().then(err => { throw new Error(err.message || 'ì‚­ì œ ì‹¤íŒ¨'); });
			        }
			        
			        // â­ï¸â­ï¸â­ï¸ ì„±ê³µ ì‹œ, í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ DBì˜ ìµœì‹  ìƒíƒœë¥¼ ë°˜ì˜ â­ï¸â­ï¸â­ï¸
			        alert('âœ… ìƒí’ˆ ì‚­ì œ ì„±ê³µ. ëª©ë¡ì„ ê°±ì‹ í•©ë‹ˆë‹¤.');
			        window.location.reload(); 
			        
			        return null;
			    })
			    .catch(error => {
			        console.error('ì‚­ì œ ì—ëŸ¬:', error);
			        alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. DB ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”: ' + error.message);
			    });
			};
	        // --- ì´ˆê¸° ë¡œë”© ì‹œ í•©ê³„ ê³„ì‚° ---
	        updateSummaryTotals();
	    });
	</script>
</body>
</html>