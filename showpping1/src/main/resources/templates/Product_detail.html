<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.name} + ' | ìœ í•œ ì˜· ë§ˆì¼“'">ìƒí’ˆ ìƒì„¸ | ìœ í•œ ì˜· ë§ˆì¼“</title>
    
    <link rel="stylesheet" th:href="@{/style/style.css}"> 

</head>
<body>

	
		<body>

			<header class="header">
			    <div class="nav-bar">
			        <div class="logo">
			           <h1 style="margin: 0;">ìœ í•œ ì˜· ë§ˆì¼“</h1>
			        </div>
			        
			        <div class="search-and-user">
			            <a th:href="@{/}" class="menu-link">í™ˆ</a>
			            <a th:href="@{/shirtlist}" class="menu-link">ìƒì˜ ëª©ë¡</a>
			            <a th:href="@{/cart}" class="menu-link">ì¥ë°”êµ¬ë‹ˆ</a>
			            
			            
			            <div class="user-status-group">
			                <span th:if="${session.user != null}" class="user-welcome">
			                    <span th:text="${session.user.username}"></span>ë‹˜, ì–´ì„œì˜¤ì„¸ìš”
			                </span>
			                
			                <a th:unless="${session.user != null}" th:href="@{/register}" class="btn btn-outline-primary btn-sm">
			                    <i class="bi bi-person-plus"></i> íšŒì›ê°€ì…
			                </a>
			                <a th:unless="${session.user != null}" th:href="@{/login}" class="btn btn-primary btn-sm">
			                    <i class="bi bi-box-arrow-in-right"></i> ë¡œê·¸ì¸
			                </a>
			                
			                <a th:if="${session.user != null}" th:href="@{/logout}" class="menu-link menu-link-button">
			                    <i class="bi bi-box-arrow-right"></i> ë¡œê·¸ì•„ì›ƒ
			                </a>
			            </div>
			        </div>
			    </div>
			</header>
	    </header>
		

	<main class="detail-container">
        
        <div class="product-layout">
            
            <div class="product-image-area">
                <div class="main-image" th:style="'background-image: url(' + ${product.imageUrl} + ');'">
                    </div>
                <div class="thumbnail-gallery">
                    </div>
            </div>
            
            <div class="product-info-area">
                
                <p class="detail-brand" th:text="${product.category.name} + ' ì¹´í…Œê³ ë¦¬'"></p>
                <h1 class="detail-title" th:text="${product.name}">[ìƒí’ˆëª…] í”„ë¦¬ë¯¸ì—„ ìš¸ ë‹ˆíŠ¸</h1>
                <hr>

                <p class="detail-price" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + 'ì›'"></p>
                
                <form id="orderForm">
                    
                    <div class="option-select">
                        <select id="size-option" required>
                            <option value="">-- ì‚¬ì´ì¦ˆë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                            <option th:each="option : ${options}" 
                                    th:value="${option.id}"
                                    th:text="${option.sizeName} + ' (ì¬ê³ : ' + ${option.stockQuantity} + ')'">
                                M (ì¬ê³ : 100)
                            </option>
                        </select>
                    </div>

                    <div class="quantity-select">
                        <input type="number" id="quantity" class="quantity-input" value="1" min="1" max="10" required>
                    </div>

                    <div class="total-price">
                        ì´ ìƒí’ˆ ê¸ˆì•¡: <span id="total-amount" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')}">79,000</span>ì›
                    </div>
                    
                    <div class="action-buttons">
                        <button type="submit" class="buy-button">ë°”ë¡œ êµ¬ë§¤</button>
                        <button type="button" class="cart-button">ì¥ë°”êµ¬ë‹ˆ</button>
                    </div>
                </form>
            </div>
            
        </div> 			<section class="detail-tabs" style="margin-top: 50px;">
			            <h2 class="section-title">ìƒí’ˆ ìƒì„¸ ì •ë³´</h2>
			            <div class="product-description" style="padding: 20px; border: 1px solid #eee;">
			                
			              
			                    <p>ì—¬ê¸°ëŠ” ìƒí’ˆì˜ ìƒì„¸ ì„¤ëª… ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>
			                
			                
			            </div>
			        </section>
					<div class="product-info-area">
					    <hr>
					    
					    <p class="detail-views" style="font-size: 0.9em; color: #6c757d;">
					        <i class="bi bi-eye"></i> ì¡°íšŒìˆ˜: 
					        <span th:text="${#numbers.formatInteger(product.viewCount, 0, 'COMMA')}">1,234</span>íšŒ
					    </p>
					    
					    <hr>
					    </div>
	</main>
	<footer class="footer">
	    </footer>

    <script>
        // ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ ì „ìš© JS ë¡œì§ (ì˜µì…˜ ì„ íƒì— ë”°ë¥¸ ê¸ˆì•¡ ê³„ì‚° ë“±)
		document.addEventListener('DOMContentLoaded', function() {
		        // --- ìš”ì†Œ ì •ì˜ ---
		        const orderForm = document.getElementById('orderForm');
		        const buyNowButton = orderForm.querySelector('.buy-button'); 
		        const addToCartButton = orderForm.querySelector('.cart-button'); 
		        const priceElement = document.querySelector('.detail-price');
		        
		        // ê°€ê²© (ìˆ«ìë§Œ ì¶”ì¶œ)
		        const priceText = priceElement.textContent.replace(/[^0-9]/g, ''); 
		        const productPrice = parseInt(priceText) || 0;
		        
		        const quantityInput = document.getElementById('quantity');
		        const totalAmountSpan = document.getElementById('total-amount');
		        const sizeOptionSelect = document.getElementById('size-option');
		        
		        // productIdëŠ” ì„œë²„ë¡œ ì „ì†¡í•  í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ ìƒëµí•´ë„ ë¬´ë°©í•˜ë‚˜, 
		        // DTOì— ë§ì¶° optionIdì™€ quantityë§Œ ë³´ëƒ…ë‹ˆë‹¤.
		        
		        // --- ê¸ˆì•¡ ê³„ì‚° ë¡œì§ ---
		        function updateTotalPrice() {
		            const quantity = parseInt(quantityInput.value) || 1;
		            const totalPrice = productPrice * quantity;
		            // ê¸ˆì•¡ì„ ì½¤ë§ˆ í˜•ì‹ìœ¼ë¡œ í¬ë§·
		            totalAmountSpan.textContent = totalPrice.toLocaleString('ko-KR');
		        }
		        
		        quantityInput.addEventListener('input', updateTotalPrice);
		        sizeOptionSelect.addEventListener('change', updateTotalPrice);
		        updateTotalPrice(); 
		        
		        // --- ì¥ë°”êµ¬ë‹ˆ/ë°”ë¡œêµ¬ë§¤ AJAX ë¡œì§ ---
		        function handleOrderAction(isBuyNow) {
		            const optionId = sizeOptionSelect.value;
		            const quantity = parseInt(quantityInput.value);

		            if (!optionId) {
		                alert('âš ï¸ ì‚¬ì´ì¦ˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
		                return;
		            }
		            if (quantity < 1) {
		                alert('âš ï¸ ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
		                return;
		            }
		            
		            // ì „ì†¡í•  ë°ì´í„° (CartControllerì˜ CartItemRequest DTOì™€ ì¼ì¹˜í•´ì•¼ í•¨)
		            const cartData = {
		                optionId: optionId, 
		                quantity: quantity  
		            };

		            // AJAX ìš”ì²­ (POST /cart/add)
					fetch('/cart/add', {
					                method: 'POST',
					                headers: {
					                    'Content-Type': 'application/json'
					                },
					                // â­ï¸â­ï¸â­ï¸ ì„¸ì…˜ ì¿ í‚¤ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ë„ë¡ ì„¤ì • (í•„ìˆ˜!) â­ï¸â­ï¸â­ï¸
					                credentials: 'include', 
					                // â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸
					                body: JSON.stringify(cartData)
					            })
					            .then(response => {
					                // 1. HTTP ìƒíƒœ ì½”ë“œ í™•ì¸ (401ì´ë©´ ë¬´ì¡°ê±´ ì¸ì¦ ì˜¤ë¥˜ë¡œ ì²˜ë¦¬)
					                if (response.status === 401) {
					                    alert('ğŸš¨ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
					                    window.location.href = '/login';
					                    return Promise.reject('UNAUTHORIZED'); // ë‹¤ìŒ ì²´ì¸ ì¤‘ë‹¨
					                }
					                
					                // 2. 200 OKê°€ ì•„ë‹ˆë©´ (ì¬ê³  ë¶€ì¡± ë“± 4xx/5xx) ì—ëŸ¬ë¡œ ì²˜ë¦¬
					                if (!response.ok) {
					                    // ì„œë²„ì—ì„œ ë³´ë‚¸ JSON ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë°›ì•„ì„œ throw
					                    return response.json().then(err => { 
					                        throw new Error(err.message || 'ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ ì¤‘ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ'); 
					                    });
					                }
					                
					                // 3. ì„±ê³µ (200 OK)
					                return response.json(); 
					            })
					            .then(data => {
					                // ì´ ë¸”ë¡ì€ 200 OKì¼ ë•Œë§Œ ì‹¤í–‰ë¨
					                if (isBuyNow) {
					                    alert('âœ… ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ë°”ë¡œ ì£¼ë¬¸/ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
					                    window.location.href = '/cart'; // ë°”ë¡œ ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™
					                } else {
					                    alert('âœ… ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ì„±ê³µì ìœ¼ë¡œ ë‹´ê²¼ìŠµë‹ˆë‹¤!');
					                }
					            })
					            .catch(error => {
					                // UNAUTHORIZED ì—ëŸ¬ëŠ” ì—¬ê¸°ì„œ ë‹¤ì‹œ ì•Œë¦¼ì„ ë„ìš°ì§€ ì•ŠìŠµë‹ˆë‹¤.
					                if (error !== 'UNAUTHORIZED') {
					                    console.error('ì¥ë°”êµ¬ë‹ˆ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
					                    alert('âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
					                }
					            });
					        }
		        // 'ë°”ë¡œ êµ¬ë§¤' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ í›„ ì´ë™)
		        buyNowButton.addEventListener('click', function(event) {
		            event.preventDefault(); 
		            handleOrderAction(true); // isBuyNow = true (ì´ë™)
		        });

		        // 'ì¥ë°”êµ¬ë‹ˆ' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ë§Œ)
		        addToCartButton.addEventListener('click', function(event) {
		            event.preventDefault(); 
		            handleOrderAction(false); // isBuyNow = false (ì´ë™ ì•ˆ í•¨)
		        });
		    });
    </script>
</body>
</html>